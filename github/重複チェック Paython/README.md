# エラーチェックシステム

本システムは、**複数施設のサービス実態CSV** と **勤怠履歴CSV** をもとに、施設間のサービス提供時間の重複や勤怠外時間のサービス提供を検出し、代替職員候補を提示します。  
`src.py` のコアロジックを利用して、**Streamlit UI** でも簡単に実行可能です。

---

## 機能概要

1. **施設間重複チェック**
   - 複数施設間で同じ従業員が同時間帯にサービス提供している場合を検出し、エラーフラグ（◯）を付与
   - 同一時間なら施設名昇順で早い方、異なる時間なら短い方へフラグ

2. **代替職員候補の提示（施設間重複）**
   - 勤怠履歴＋他施設の稼働状況から、該当時間帯に勤務可能な従業員を抽出

3. **勤怠履歴超過チェック**
   - 実際の勤務時間外にサービス提供している従業員を検出し、エラーフラグを付与

4. **代替職員候補の提示（勤怠履歴超過）**
   - 同上のロジックで候補を提示

5. **グリッド表示機能**
   - UI上でデータをグリッド形式で表示
   - 必要カラム：A, B, C, D, E, F, G, AB

6. **ビュー機能**
   - 利用者ごとの表示ビュー
   - 従業員ごとの表示ビュー
   - その他カスタムビューの作成

7. **勤務時間最適化提案**
   - 特定の従業員の勤務データを分析
   - 理想的な勤務時間パターンを複数提案
   - ユーザーが選択可能な提案システム

8. **結果出力**
   - `result_*.csv` として、各施設ごとに出力
   - 任意で `diagnostics/` に診断用CSVを保存可能

---

## データ仕様

### サービス実態データ
- 施設ごとに別ファイル（例：`サービス実態A.csv`, `サービス実態B.csv`）
- 列：利用者・担当所員・サービス開始/終了日時 など
- **注意**：終了時刻が最大 35:00 まで（翌日1:00までを同日扱い）

### 勤怠履歴データ
- 全施設共通の1ファイル（例：`勤怠履歴.csv`）
- 出退勤1/2、休憩1/2などのカラムが存在
- 出勤列が空欄の日は勤務なし扱い
- 勤怠時間も最大 35:00 まで表記される可能性あり

---

## 環境構築

```bash
python3 -m venv venv
source venv/bin/activate

pip install -r requirements.txt
```

`requirements.txt` 例：
```txt
pandas>=2.0.0
streamlit>=1.36.0
numpy>=1.24.0
plotly>=5.0.0
```

---

## CLI での実行方法

```bash
python src.py --input /path/to/input_dir --use-schedule-when-missing
```

- `--input` : サービス実態CSV群と勤怠履歴CSVが入ったディレクトリ
- `--use-schedule-when-missing` : 実打刻欠損時に予定データで補完

結果は同ディレクトリに `result_*.csv` として出力されます。

---

## Streamlit UI での実行方法

```bash
streamlit run streamlit_app.py
```

### UI 操作手順

#### 基本的なエラーチェック
1. サイドバーでオプションを設定
2. 「サービス実態CSVをアップロード」で複数施設分のCSVを選択
3. 「勤怠履歴CSVをアップロード」で1つのCSVを選択
4. 「エラーチェックを実行する」を押す
5. **結果サマリー**と**result_*.csv のダウンロードリンク**が表示される
   （必要に応じて全結果ZIPもダウンロード可能）

#### 勤務時間最適化提案機能
エラーチェック実行後、以下の手順で勤務時間最適化提案を利用できます：

1. **従業員選択**
   - 「🎯 勤務時間最適化提案」セクションで対象従業員を選択
   - 「勤務時間分析を実行」ボタンをクリック

2. **現状分析の確認**
   - 総勤務日数、総勤務時間、平均日勤務時間の統計情報
   - エラー件数とエラータイプ別の分析
   - 勤務時間パターンの可視化（時系列グラフ、日別勤務時間）

3. **最適化提案の確認**
   - **微調整パターン**: 現在の勤務時間を15分単位で調整
   - **サービス最適化パターン**: サービス提供時間に合わせた最適化
   - **重複最小化パターン**: 他の従業員との重複を避けた勤務時間
   - **均等化パターン**: 全従業員の労働時間を均等化

4. **提案の採用とエクスポート**
   - 各提案パターンの詳細（現在vs提案の比較、期待される効果）を確認
   - 「この提案を採用」ボタンで提案を選択
   - 「最適化提案をCSVでダウンロード」で結果をエクスポート

---

## 勤務時間最適化提案機能の詳細

### 分析対象データ
- **勤怠履歴データ**: 従業員の出勤・退勤時間、休憩時間
- **サービス提供データ**: 実際の業務時間と担当者
- **エラー発生状況**: 重複や勤怠履歴超過の分析

### 提案アルゴリズム

#### 1. 微調整パターン
- **目的**: 現在の勤務パターンを基準とした最小限の調整
- **手法**: 平均的な勤務時間を15分単位に整理
- **メリット**: 管理しやすい時間設定、現在からの変更が最小限
- **実現可能性**: 高（90%）

#### 2. サービス最適化パターン
- **目的**: サービス提供時間に最適化した勤務時間
- **手法**: サービス開始の30分前から終了の30分後まで勤務時間を設定
- **メリット**: 勤怠履歴超過エラーの削減、効率的な業務時間配分
- **実現可能性**: 中（80%）

#### 3. 重複最小化パターン
- **目的**: 他の従業員との重複を最小化
- **手法**: 他の従業員の繁忙時間を避けた勤務時間を提案
- **メリット**: 施設間重複エラーの削減、リソースの効率的な配分
- **実現可能性**: 中（70%）

#### 4. 均等化パターン
- **目的**: 全従業員の労働時間を均等化
- **手法**: 全従業員の平均労働時間に基づいた勤務時間を提案
- **メリット**: 公平な労働時間配分、標準的な勤務時間への調整
- **実現可能性**: 低（60%）

### 可視化機能
- **統計情報**: メトリクス形式での現状把握
- **エラー分析**: 円グラフによるエラータイプ別分布
- **勤務パターン**: 時系列グラフによる勤務時間の推移
- **比較表示**: 現状vs提案の詳細比較

### エクスポート機能
採用された最適化提案は以下の情報を含むCSVファイルとしてダウンロード可能：
- 従業員名、提案パターン名
- 現在の勤務時間と提案勤務時間
- 勤務時間変更量、エラー削減予想数
- 実現可能性スコア、提案の詳細説明

---

## 出力例

- **エラー列**: `◯`（該当行のみ）
- **カテゴリ列**: `施設間重複` または `勤怠履歴超過`
- **代替職員リスト列**: 候補名を `/` 区切りで記載、候補なしは `ー`

---

## 注意点

- 氏名は**正規化処理**を通して照合されます（記号除去、Unicode正規化、異字体統一、頭の◯除去など）
- 勤怠とサービス実態の時間比較では、最大 35:00 表記を24時間超の時間として処理
- 入力ファイルはUTF-8 BOM付きCSVを推奨
