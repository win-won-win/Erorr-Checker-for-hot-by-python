# jinjer向けCSV出力仕様メモ

Streamlitアプリから出力する各種「最適勤怠データCSV」は、以下の条件を満たす状態で jinjer へアップロードできることを確認しました。今後同様の形式を維持するための備忘録としてまとめます。

## 共通仕様

- ヘッダーは **194 列** の `create_jinjer_headers()` をベースに出力する。
- CSV エンコードは `Shift_JIS`（=`cp932`）でダウンロード提供する。
- 以下のカラム群は jinjer では値を受け付けないため、常に **空文字（ブランク）** にする。
  - `スケジュール雛形ID`
  - 休日休暇関連 10 列  
    `休日休暇名1`, `休日休暇名1：種別`, `休日休暇名1：開始時間`, `休日休暇名1：終了時間`, `休日休暇名1：理由`,  
    `休日休暇名2`, `休日休暇名2：種別`, `休日休暇名2：開始時間`, `休日休暇名2：終了時間`, `休日休暇名2：理由`
  - 直行／直帰関連 20 列  
    `直行1`〜`直行10`, `直帰1`〜`直帰10`
  - 打刻区分 ID 50 列  
    `打刻区分ID:1`〜`打刻区分ID:50`
- 休憩補正系の出力（「最適休憩時間CSV」「休憩時間一括変更CSV」）では、元データの列順が保持されつつ上記カラムがブランク化されるよう `dataframe_to_jinjer_csv_bytes()` を利用する。
- `generate_jinjer_csv()` / `generate_0_24_jinjer_csv()` も同じブランク化ロジックを適用済み。
- `generate_delete_attendance_csv()` は選択した従業員の `出勤/退勤` カラムのうち元データで値が存在するものだけを `"Null"` に置き換え、その他は既定のブランク設定を維持する。

## 実装メモ

- 空欄が必要な列は `FORCED_EMPTY_COLUMNS` 定数に集約。
- DataFrame ベースの出力は `dataframe_to_jinjer_csv_bytes()` 内で `FORCED_EMPTY_COLUMNS` を強制ブランク化。
- 文字列ビルドで出力するケース（例: `generate_jinjer_csv`）では、行を確定する直前に `enforce_forced_empty_fields()` を呼び出し空欄へ統一する。
- 24時間系のCSV（`generate_jinjer_csv` / `generate_0_24_jinjer_csv`）では `出勤1=0:00` / `退勤1=24:00` とし、`出勤2` 以降はブランクを出力する。労働時間計算列は `総労働時間=24:00`, `実労働時間=23:00`, `休憩時間=1:00`, `総残業時間=16:00`, `法定外残業時間=16:00` の固定値を出力。
- 一括削除CSVでは `出勤1〜出勤10` / `退勤1〜退勤10` のうち元データで値が入っていたカラムのみ `"Null"` に置換し、それ以外はブランクを維持する（強制ブランク列の仕様も同様）。
- 一括削除CSVは選択従業員の確認画面（一覧表示 → 承認ボタン → ダウンロード）を必ず経由して生成する。

この仕様を守ることで、jinjer 側のバリデーションエラー（直行直帰／打刻区分ID／休日休暇系の値が入っている等）が発生せず、安定して取り込める。必要に応じて追加でブランク化が必要な列が出た場合は、`FORCED_EMPTY_COLUMNS` とこのメモを併せて更新する。***
