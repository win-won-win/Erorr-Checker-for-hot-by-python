#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ã€Œé‡è¤‡åˆ©ç”¨è€…åã€ã¨ã€Œé‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã€åˆ—ã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""
import pandas as pd
import os
import sys
from pathlib import Path

# streamlit_app.pyã‹ã‚‰å¿…è¦ãªé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
sys.path.append('.')
from streamlit_app import prepare_grid_data, extract_facility_name_from_filename

def create_test_data():
    """ãƒ†ã‚¹ãƒˆç”¨ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"""
    print("=== ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ ===")
    
    # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿1ï¼ˆã•ãã‚‰äº‹æ¥­æ‰€ï¼‰
    test_data_1 = {
        'ã‚¨ãƒ©ãƒ¼': ['â—¯', '', 'â—¯', ''],
        'ã‚«ãƒ†ã‚´ãƒª': ['æ–½è¨­é–“é‡è¤‡', '', 'æ–½è¨­é–“é‡è¤‡', ''],
        'ä»£æ›¿è·å“¡ãƒªã‚¹ãƒˆ': ['ãƒ¼', 'ãƒ¼', 'ç”°ä¸­ä¸€éƒ', 'ãƒ¼'],
        'é‡è¤‡æ™‚é–“ï¼ˆåˆ†ï¼‰': [60, 0, 30, 0],
        'è¶…éæ™‚é–“ï¼ˆåˆ†ï¼‰': [0, 0, 0, 0],
        'é‡è¤‡ç›¸æ‰‹æ–½è¨­': ['result_ã»ã£ã¨202508.csv', '', 'result_ã»ã£ã¨202508.csv', ''],
        'é‡è¤‡ç›¸æ‰‹æ‹…å½“è€…': ['å±±ç”°èŠ±å­', '', 'ä½è—¤æ¬¡éƒ', ''],
        'é‡è¤‡ã‚¿ã‚¤ãƒ—': ['å®Œå…¨é‡è¤‡', '', 'éƒ¨åˆ†é‡è¤‡', ''],
        'ã‚«ãƒãƒ¼çŠ¶æ³': ['å®Œå…¨ã‚«ãƒãƒ¼', 'å®Œå…¨ã‚«ãƒãƒ¼', 'å®Œå…¨ã‚«ãƒãƒ¼', 'å®Œå…¨ã‚«ãƒãƒ¼'],
        'å‹¤å‹™åŒºé–“æ•°': [6, 5, 3, 4],
        'è©³ç´°ID': ['ã•ãã‚‰_001', 'ã•ãã‚‰_002', 'ã•ãã‚‰_003', 'ã•ãã‚‰_004'],
        'æ—¥ä»˜': ['ä»¤å’Œ07å¹´02æœˆ01æ—¥ (åœŸ)', 'ä»¤å’Œ07å¹´02æœˆ01æ—¥ (åœŸ)', 'ä»¤å’Œ07å¹´02æœˆ01æ—¥ (åœŸ)', 'ä»¤å’Œ07å¹´02æœˆ02æ—¥ (æ—¥)'],
        'æ™‚é–“': ['09:00ï½10:00', '10:00ï½11:00', '15:00ï½16:00', '11:00ï½12:00'],
        'åˆ©ç”¨è€…å': ['ç”°ä¸­å¤ªéƒ', 'ä½è—¤æ¬¡éƒ', 'å°æ—äº”éƒ', 'é«˜æ©‹ä¸‰éƒ'],
        'ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹': ['èº«ä½“', 'èº«ä½“', 'èº«ä½“', 'èº«ä½“'],
        'æ‹…å½“æ‰€å“¡': ['å±±ç”°èŠ±å­', 'éˆ´æœ¨ä¸€éƒ', 'ä½è—¤ä¸ƒå­', 'ç”°ä¸­äº”éƒ'],
        'é–‹å§‹æ™‚é–“': ['9:00', '10:00', '15:00', '11:00'],
        'çµ‚äº†æ™‚é–“': ['10:00', '11:00', '16:00', '12:00'],
        'å®Ÿæ–½æ™‚é–“': [60, 60, 60, 60],
        'é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“': ['9:00-10:00', '', '15:00-15:30', '']
    }
    
    # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿2ï¼ˆã»ã£ã¨äº‹æ¥­æ‰€ï¼‰
    test_data_2 = {
        'ã‚¨ãƒ©ãƒ¼': ['â—¯', '', 'â—¯'],
        'ã‚«ãƒ†ã‚´ãƒª': ['æ–½è¨­é–“é‡è¤‡', '', 'æ–½è¨­é–“é‡è¤‡'],
        'ä»£æ›¿è·å“¡ãƒªã‚¹ãƒˆ': ['ãƒ¼', 'ãƒ¼', 'éˆ´æœ¨äºŒéƒ'],
        'é‡è¤‡æ™‚é–“ï¼ˆåˆ†ï¼‰': [60, 0, 30],
        'è¶…éæ™‚é–“ï¼ˆåˆ†ï¼‰': [0, 0, 0],
        'é‡è¤‡ç›¸æ‰‹æ–½è¨­': ['result_ã•ãã‚‰202508.csv', '', 'result_ã•ãã‚‰202508.csv'],
        'é‡è¤‡ç›¸æ‰‹æ‹…å½“è€…': ['ä½è—¤ä¸ƒå­', '', 'å±±ç”°èŠ±å­'],
        'é‡è¤‡ã‚¿ã‚¤ãƒ—': ['å®Œå…¨é‡è¤‡', '', 'éƒ¨åˆ†é‡è¤‡'],
        'ã‚«ãƒãƒ¼çŠ¶æ³': ['å®Œå…¨ã‚«ãƒãƒ¼', 'å®Œå…¨ã‚«ãƒãƒ¼', 'å®Œå…¨ã‚«ãƒãƒ¼'],
        'å‹¤å‹™åŒºé–“æ•°': [4, 3, 5],
        'è©³ç´°ID': ['ã»ã£ã¨_001', 'ã»ã£ã¨_002', 'ã»ã£ã¨_003'],
        'æ—¥ä»˜': ['ä»¤å’Œ07å¹´02æœˆ01æ—¥ (åœŸ)', 'ä»¤å’Œ07å¹´02æœˆ01æ—¥ (åœŸ)', 'ä»¤å’Œ07å¹´02æœˆ01æ—¥ (åœŸ)'],
        'æ™‚é–“': ['09:00ï½10:00', '12:00ï½13:00', '15:00ï½16:00'],
        'åˆ©ç”¨è€…å': ['ä¸­æ‘å››éƒ', 'æ¸¡è¾ºå…­éƒ', 'ä¼Šè—¤ä¸ƒéƒ'],
        'ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹': ['èº«ä½“', 'èº«ä½“', 'èº«ä½“'],
        'æ‹…å½“æ‰€å“¡': ['ä½è—¤ä¸ƒå­', 'ç”°ä¸­äº”éƒ', 'å±±ç”°èŠ±å­'],
        'é–‹å§‹æ™‚é–“': ['9:00', '12:00', '15:00'],
        'çµ‚äº†æ™‚é–“': ['10:00', '13:00', '16:00'],
        'å®Ÿæ–½æ™‚é–“': [60, 60, 60],
        'é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“': ['9:00-10:00', '', '15:00-15:30']
    }
    
    # DataFrameã‚’ä½œæˆ
    df1 = pd.DataFrame(test_data_1)
    df2 = pd.DataFrame(test_data_2)
    
    # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    test_dir = "test_duplicate_columns"
    os.makedirs(test_dir, exist_ok=True)
    
    # CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
    test_path_1 = f"{test_dir}/result_ã•ãã‚‰202508.csv"
    test_path_2 = f"{test_dir}/result_ã»ã£ã¨202508.csv"
    
    df1.to_csv(test_path_1, index=False, encoding='utf-8-sig')
    df2.to_csv(test_path_2, index=False, encoding='utf-8-sig')
    
    print(f"âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†:")
    print(f"  - {test_path_1} ({len(df1)}è¡Œ)")
    print(f"  - {test_path_2} ({len(df2)}è¡Œ)")
    
    return [test_path_1, test_path_2]

def test_facility_name_extraction():
    """äº‹æ¥­æ‰€åæŠ½å‡ºæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
    print("\n=== äº‹æ¥­æ‰€åæŠ½å‡ºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===")
    
    test_cases = [
        ("result_ã•ãã‚‰202508.csv", "ã•ãã‚‰"),
        ("result_ã»ã£ã¨202508.csv", "ã»ã£ã¨"),
        ("result_ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹å¤ªé™½202508.csv", "ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹å¤ªé™½"),
        ("result_ã‚±ã‚¢ã‚»ãƒ³ã‚¿ãƒ¼èŠ±202508.csv", "ã‚±ã‚¢ã‚»ãƒ³ã‚¿ãƒ¼èŠ±")
    ]
    
    all_passed = True
    for filename, expected in test_cases:
        result = extract_facility_name_from_filename(filename)
        if result == expected:
            print(f"âœ… {filename} -> {result}")
        else:
            print(f"âŒ {filename} -> {result} (æœŸå¾…å€¤: {expected})")
            all_passed = False
    
    return all_passed

def test_duplicate_columns_functionality():
    """é‡è¤‡åˆ—æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ"""
    print("\n=== é‡è¤‡åˆ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===")
    
    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    test_paths = create_test_data()
    
    try:
        # prepare_grid_dataé–¢æ•°ã‚’å®Ÿè¡Œ
        grid_df = prepare_grid_data(test_paths)
        
        print(f"âœ… ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ç”ŸæˆæˆåŠŸ: {len(grid_df)}è¡Œ")
        
        # æœŸå¾…ã•ã‚Œã‚‹åˆ—ã®å­˜åœ¨ç¢ºèª
        expected_columns = [
            'ã‚¨ãƒ©ãƒ¼', 'ã‚«ãƒ†ã‚´ãƒª', 'ä»£æ›¿è·å“¡ãƒªã‚¹ãƒˆ', 'æ‹…å½“æ‰€å“¡', 'åˆ©ç”¨è€…å', 
            'é‡è¤‡åˆ©ç”¨è€…å', 'é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€å', 'é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“', 
            'æ—¥ä»˜', 'é–‹å§‹æ™‚é–“', 'çµ‚äº†æ™‚é–“', 'ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°', 'é‡è¤‡æ™‚é–“', 'è¶…éæ™‚é–“'
        ]
        
        missing_columns = [col for col in expected_columns if col not in grid_df.columns]
        if missing_columns:
            print(f"âŒ ä¸è¶³ã—ã¦ã„ã‚‹åˆ—: {missing_columns}")
            return False
        
        print("âœ… å…¨ã¦ã®æœŸå¾…ã•ã‚Œã‚‹åˆ—ãŒå­˜åœ¨")
        
        # åˆ—ã®é †åºç¢ºèª
        actual_order = list(grid_df.columns[:len(expected_columns)])
        if actual_order == expected_columns:
            print("âœ… åˆ—ã®é †åºãŒæ­£ã—ã„")
        else:
            print(f"âŒ åˆ—ã®é †åºãŒä¸æ­£:")
            print(f"  æœŸå¾…å€¤: {expected_columns}")
            print(f"  å®Ÿéš›å€¤: {actual_order}")
            return False
        
        # ã‚¨ãƒ©ãƒ¼è¡Œã®ç¢ºèª
        error_rows = grid_df[grid_df['ã‚¨ãƒ©ãƒ¼'] == 'â—¯']
        print(f"âœ… ã‚¨ãƒ©ãƒ¼è¡Œæ•°: {len(error_rows)}ä»¶")
        
        # é‡è¤‡åˆ©ç”¨è€…åã®æ¤œè¨¼
        print("\n--- é‡è¤‡åˆ©ç”¨è€…åã®æ¤œè¨¼ ---")
        for idx, row in grid_df.iterrows():
            error_status = row['ã‚¨ãƒ©ãƒ¼']
            user_name = row['åˆ©ç”¨è€…å']
            duplicate_user_name = row['é‡è¤‡åˆ©ç”¨è€…å']
            
            if error_status == 'â—¯':
                # ã‚¨ãƒ©ãƒ¼è¡Œã§ã¯é‡è¤‡åˆ©ç”¨è€…åãŒåˆ©ç”¨è€…åã¨åŒã˜ã§ã‚ã‚‹ã¹ã
                if duplicate_user_name == user_name:
                    print(f"âœ… è¡Œ{idx}: ã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡åˆ©ç”¨è€…åãŒæ­£ã—ãè¨­å®š ({duplicate_user_name})")
                else:
                    print(f"âŒ è¡Œ{idx}: ã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡åˆ©ç”¨è€…åãŒä¸æ­£ (æœŸå¾…å€¤: {user_name}, å®Ÿéš›å€¤: {duplicate_user_name})")
                    return False
            else:
                # éã‚¨ãƒ©ãƒ¼è¡Œã§ã¯é‡è¤‡åˆ©ç”¨è€…åãŒç©ºã§ã‚ã‚‹ã¹ã
                if duplicate_user_name == '':
                    print(f"âœ… è¡Œ{idx}: éã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡åˆ©ç”¨è€…åãŒç©ºç™½")
                else:
                    print(f"âŒ è¡Œ{idx}: éã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡åˆ©ç”¨è€…åãŒç©ºç™½ã§ãªã„ ({duplicate_user_name})")
                    return False
        
        # é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã®æ¤œè¨¼
        print("\n--- é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã®æ¤œè¨¼ ---")
        for idx, row in grid_df.iterrows():
            error_status = row['ã‚¨ãƒ©ãƒ¼']
            service_time = row['é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“']
            
            if error_status == 'â—¯':
                if service_time and service_time != '':
                    print(f"âœ… è¡Œ{idx}: ã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ãŒè¨­å®š ({service_time})")
                else:
                    print(f"âš ï¸ è¡Œ{idx}: ã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ãŒç©º (ãƒ‡ãƒ¼ã‚¿ä¾å­˜)")
            else:
                if service_time == '':
                    print(f"âœ… è¡Œ{idx}: éã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ãŒç©ºç™½")
                else:
                    print(f"âŒ è¡Œ{idx}: éã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ãŒç©ºç™½ã§ãªã„ ({service_time})")
        
        # é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€åã®æ¤œè¨¼
        print("\n--- é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€åã®æ¤œè¨¼ ---")
        for idx, row in grid_df.iterrows():
            error_status = row['ã‚¨ãƒ©ãƒ¼']
            facility_name = row['é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€å']
            
            if error_status == 'â—¯':
                if facility_name and facility_name != '':
                    print(f"âœ… è¡Œ{idx}: ã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€åãŒè¨­å®š ({facility_name})")
                else:
                    print(f"âš ï¸ è¡Œ{idx}: ã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€åãŒç©º")
            else:
                if facility_name == '':
                    print(f"âœ… è¡Œ{idx}: éã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€åãŒç©ºç™½")
                else:
                    print(f"âŒ è¡Œ{idx}: éã‚¨ãƒ©ãƒ¼è¡Œã§é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€åãŒç©ºç™½ã§ãªã„ ({facility_name})")
        
        # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
        print("\n--- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®5è¡Œï¼‰ ---")
        display_cols = ['ã‚¨ãƒ©ãƒ¼', 'åˆ©ç”¨è€…å', 'é‡è¤‡åˆ©ç”¨è€…å', 'é‡è¤‡ã‚¨ãƒ©ãƒ¼äº‹æ¥­æ‰€å', 'é‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“']
        print(grid_df[display_cols].head().to_string())
        
        return True
        
    except Exception as e:
        print(f"âŒ é‡è¤‡åˆ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

def cleanup_test_data():
    """ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
    import shutil
    test_dir = "test_duplicate_columns"
    if os.path.exists(test_dir):
        shutil.rmtree(test_dir)
        print(f"âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: {test_dir}")

def main():
    """ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    print("ã€Œé‡è¤‡åˆ©ç”¨è€…åã€ã¨ã€Œé‡è¤‡ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã€åˆ—ã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 60)
    
    tests = [
        test_facility_name_extraction,
        test_duplicate_columns_functionality
    ]
    
    passed = 0
    total = len(tests)
    
    try:
        for test_func in tests:
            try:
                if test_func():
                    passed += 1
                    print(f"âœ… {test_func.__name__} æˆåŠŸ")
                else:
                    print(f"âŒ {test_func.__name__} å¤±æ•—")
            except Exception as e:
                print(f"âŒ {test_func.__name__} ä¾‹å¤–ç™ºç”Ÿ: {str(e)}")
            print("-" * 40)
        
        print(f"\nãƒ†ã‚¹ãƒˆçµæœ: {passed}/{total} æˆåŠŸ")
        
        if passed == total:
            print("ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼")
            return True
        else:
            print("âš ï¸ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚")
            return False
    
    finally:
        # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        cleanup_test_data()

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)